<script setup lang="ts">

    definePageMeta({
        layout: 'navigator'
    })

    const url = "/api/records/record"
    const fileInput = ref<HTMLInputElement | null >(null)
    const responsedUrl = ref<string>("")
    const previewUrl = ref<string>("")

    const postData = reactive({
        userId: "",
        categoryId: "",
        recordName: "",
        imageUrl: "",
        imageDescription: "",
    })
    const getIllustration = async (event: Event) => {
        event.preventDefault();
        const file = fileInput.value?.files?.[0];
        if(!file) return 
        const responsedImageUrl = await useImageUploader(file)

        if(responsedImageUrl["image_url"]){
            responsedUrl.value = responsedImageUrl["image_url"]
            postData.imageUrl = responsedUrl.value
            console.log("イラストURL :",postData.imageUrl)
        }
    }

    const getPreview = async (event: Event) => {
        event.preventDefault();
        const file = fileInput.value?.files?.[0];
        if(!file) return 
        previewUrl.value = URL.createObjectURL(file);
    }

    const createNewRecord = async () => {
        if(postData.imageUrl == ""){
            console.log("Image is Empty")
            return 
        }
        
        const res = await useFetch(url,{
            method: 'POST',
            body: postData,
        })



    }
</script>

<template>
    <v-container class="flex flex-row justify-center m-10 p-2">
            <v-file-input 
              ref="fileInput" 
              class="max-w-xs m-5 p-3" 
              label="Select Image to Illustrate"
              @change="getPreview" />
            <v-text-field
              v-model="postData.imageUrl"
              class="w-1/3 m-5"
              label="イラストURL手動入力"/>
    </v-container>
    <v-sheet class="flex m-10 text-center">
            <v-btn  
              class="m-5"
              prepend-icon="$vuetify" 
              append-icon="$vuetify" 
              variant="outlined"
              @click="getIllustration" >
                イラスト生成
            </v-btn>
            <v-btn 
              class="m-5" 
              prepend-icon="$vuetify" 
              append-icon="$vuetify" 
              variant="outlined"
              @click="createNewRecord" >
                画像の保存
            </v-btn>
    </v-sheet>

    <v-container class="flex flex-row justify-center">
        <!-- プレビュー画像-->
        <div v-if='previewUrl!=""' class=" w-1/3 flex flex-col flex-wrap md:flex-row md:justify-center m-10">
            <UiImageCard :image_url=previewUrl>
                <template #title/>
            </UiImageCard>
        </div>
    <!-- レスポンス -->
        <div v-if='responsedUrl!="" ' class="w-1/3 flex flex-col flex-wrap md:flex-row md:justify-center m-10">
            <UiImageCard :image_url=responsedUrl>
                <template #title>
                    <h1> カード名 </h1>
                </template>
            </UiImageCard>
        </div>
    </v-container>

    <v-sheet class="flex-row justify-center m-10 p-2">
        <v-text-field 
          v-model="postData.userId" 
          class="w-1/3"
          label="user id の設定" />
        <v-text-field 
          v-model="postData.categoryId" 
          class="w-1/3"
          label="category id の設定" />
        <v-text-field 
          v-model="postData.recordName" 
          class="w-1/3"
          label="record name の設定" />
        <v-text-field 
          v-model="postData.imageDescription"
          class="w-1/3"
          label="image の説明" />
    </v-sheet>

</template>
